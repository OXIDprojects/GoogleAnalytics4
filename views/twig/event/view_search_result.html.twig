{% set gtmProducts = oView.getArticleList() %}

{% block d3_ga4_view_search_result_block %}
  {% if gtmProducts %}
    {% capture name = "d3_ga4_view_search_result" %}
      {% spaceless %}
        dataLayer.push({"event": null, "eventLabel": null, "ecommerce": null});  /* Clear the previous ecommerce object. */
        dataLayer.push({
          'event': 'view_search_result',
          'eventLabel':'view_search_result{% if oViewConf.isDebugModeOn() %}_test{% endif %}',
          'ecommerce': {
            'search_term': '{{ searchparamforhtml }}',
            'items': [
              {% for gtmProduct in gtmProducts %}
              {% set d3PriceObject = gtmProduct.getPrice() %}
              {% set gtmManufacturer = gtmProduct.getManufacturer() %}
              {% set gtmCategory = gtmProduct.getCategory() %}
              {
                'item_id': '{{ gtmProduct.getFieldData("oxartnum") }}',
                'item_name': '{{ gtmProduct.getFieldData("oxtitle") }}',
                'price': {{ d3PriceObject.getPrice() }},
                'item_brand': '{% if gtmManufacturer %}{{ gtmManufacturer.oxmanufacturers__oxtitle.value }}{% endif %}',
                {% if gtmCategory %}
                'item_category':  '{{ gtmCategory.getSplitCategoryArray(0, true) }}',
                'item_category_2':'{{ gtmCategory.getSplitCategoryArray(1, true) }}',
                'item_category_3':'{{ gtmCategory.getSplitCategoryArray(2, true) }}',
                'item_category_4':'{{ gtmCategory.getSplitCategoryArray(3, true) }}',
                'item_list_name':'{{ gtmCategory.getSplitCategoryArray() }}',
                {% endif %}
                'quantity': 1
              }{% if not loop.last %},{% endif %}
              {% endfor %}
            ]
          }{% if oViewConf.isDebugModeOn() %},
          'debug_mode': 'true'
          {% endif %}
        });
      {% endspaceless %}
    {% endcapture %}
    {{ script({ add: smarty.capture.d3_ga4_view_search_result, dynamic: __oxid_include_dynamic }) }}
  {% endif %}
{% endblock %}

{% include '@d3googleanalytics4/event/add_to_cart.html.twig' with {htmlIdAmountOfArticles: '#amountToBasket'} %}