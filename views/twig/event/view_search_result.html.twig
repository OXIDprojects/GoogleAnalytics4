{% set gtmProducts = oView.getArticleList() %}

{% block d3_ga4_view_search_result_block %}
    {% if gtmProducts %}
        {% set doNotShow %}{% apply spaceless %}
            <script type="text/javascript">
                {% set d3_ga4_view_search_result %}{% apply spaceless %}
                    dataLayer.push({"event": null, "eventLabel": null, "ecommerce": null});
                    dataLayer.push({
                        'event': 'view_search_result',
                        'eventLabel':'view_search_result{% if oViewConf.isDebugModeOn() %}_test{% endif %}',
                        'ecommerce': {
                            'search_term': '{{ searchparamforhtml }}',
                            'items': [
                                {% for gtmProduct in gtmProducts %}
                                    {% set d3PriceObject = gtmProduct.getPrice() %}
                                    {% set gtmManufacturer = gtmProduct.getManufacturer() %}
                                    {% set gtmCategory = gtmProduct.getCategory() %}
                                    {
                                        'item_oxid': '{{ gtmProduct.getFieldData("oxid") }}',
                                        'item_id': '{{ gtmProduct.getFieldData("oxartnum") }}',
                                        'item_name': '{{ gtmProduct.getRawFieldData('oxtitle')|raw }}',
                                        'price': {{ d3PriceObject.getPrice() }},
                                        'item_brand': '{% if gtmManufacturer %}{{ gtmManufacturer.getFieldData('oxtitle')|raw }}{% endif %}',
                                        {% if gtmCategory %}
                                            'item_category':  '{{ gtmCategory.getSplitCategoryArray(0, true) }}',
                                            'item_category2':'{{ gtmCategory.getSplitCategoryArray(1, true) }}',
                                            'item_category3':'{{ gtmCategory.getSplitCategoryArray(2, true) }}',
                                            'item_category4':'{{ gtmCategory.getSplitCategoryArray(3, true) }}',
                                            'item_list_name':'{{ gtmCategory.getSplitCategoryArray() }}',
                                        {% endif %}
                                        'quantity': 1
                                    }{% if not loop.last %},{% endif %}
                                {% endfor %}
                            ]
                        }{% if oViewConf.isDebugModeOn() %},
                            'debug_mode': 'true'
                        {% endif %}
                    });
                {% endapply %}{% endset %}
                {{ script({ add: d3_ga4_view_search_result.__toString(), dynamic: __oxid_include_dynamic }) }}
            </script>
        {% endapply %}{% endset %}
    {% endif %}
{% endblock %}

{# ToDo: fix add_to_cart! #}
{# {% include '@d3googleanalytics4/event/add_to_cart.html.twig' with {htmlIdAmountOfArticles: 'amountToBasket'} %} #}